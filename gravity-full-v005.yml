---

- hosts: all
  become: true
  pre_tasks:

  - name: update repo cache (CentOS)
    tags: always
    dnf:
      update_cache: yes
    changed_when: false
    when: ansible_distribution == "CentOS"

  - name: update repo cache (Ubuntu)
    tags: always
    apt:
      update_cache: yes
    changed_when: yes
    when: ansible_distribution == "Ubuntu"

- hosts: all
  become: true
  vars_prompt:

    - name: username
      prompt: What is your username?
      private: no

    - name: password
      prompt: What is your password?

  tasks:

    - name: Create the Althea-bin directory if it does not exist
      ansible.builtin.file:
        path: '/home/{{ username }}/althea-bin'
        state: directory
        owner: '{{ username }}'
        group: '{{ username }}'
        mode: '0755'

    - name: Change to the althea-bin directory and download the Gravity Bridge files
      shell: cd '/home/{{ username }}/althea-bin'

    - name: Download the Althea chain binary
      get_url:
        url: https://github.com/althea-net/althea-chain/releases/download/v0.0.5/althea-0.0.4-16-g6812f87-linux-amd64
        dest: '/home/{{ username }}/althea-bin/althea'
        owner: '{{ username }}'
        group: '{{ username }}'
        mode: '0775'

    - name: Download tools for the Gravity Bridge from the gravity repo
      get_url:
        url: "https://github.com/althea-net/althea-chain/releases/download/v0.0.5/{{ item }}"
        dest: '/home/{{ username }}/althea-bin'
        owner: '{{ username }}'
        group: '{{ username }}'
        mode: '0775'
      with_items:
        - client
        - orchestrator
        - register-delegate-keys
        - relayer

    - name: copy file and set permissions
      copy:
        src: '/home/{{ username }}/althea-bin/{{ item }}'
        dest: /usr/bin
        remote_src: yes
        mode: a+x
      with_items:
        - althea
        - client
        - orchestrator
        - register-delegate-keys
        - relayer

    - name: Download the Althea key creation script
      get_url:
        url: https://raw.githubusercontent.com/lightiv/ansible/gravity_bridge/files/setup.sh
        dest: '/home/{{ username }}/'
        owner: '{{ username }}'
        group: '{{ username }}'
        mode: '0775'

    - name: Change to the root directory
      shell: cd ~/

    - name: Initialize the node
      shell: althea init '{{ username }}' -o --chain-id althea-testnet1v5

    - name: Download the gravity bridge genesis
      get_url:
        url: https://github.com/althea-net/althea-chain/releases/download/v0.0.5/althea-testnet1-v5-genesis.json
        dest: '/home/{{ username }}/.althea/config/genesis.json'
        owner: '{{ username }}'
        group: '{{ username }}'
        mode: '0775'

    - name: Step 1 in now complete
      debug:
        msg:
          - 'Things left to do:'
          - '- Proceed to Step 2.  Please see the Step 2 instructions'
